#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1

run_dir=$1 && shift

if [[ -z "${run_dir}" ]]; then
    error "Parameters missing. Exiting.";
fi

download_isofox_to_run_dir ${run_dir}
if [[ -d "${run_dir}/isofox" ]]; then
    # Make sure sample is present in the sample metadata file for RNA!
    load_isofox_data_to_prod ${run_dir}

    run_cuppa_dna_rna_prod ${run_dir}
    generate_cup_dna_rna_report ${run_dir}

    # Rerunning ORANGE to pick up CUPPA DNA-RNA.
    run_orange_in_actin_mode ${run_dir}
fi

download_rna_bam_to_run_dir ${run_dir}
rna_bam_dir="$(locate_rna_bam_directory ${run_dir})"
if [[ -d "${rna_bam_dir}" ]]; then
    # TODO Fix once PAVE has been upgraded to v1.1 and rerun (pipeline v5.28)
    #annotate_somatic_variants_with_rna ${run_dir}
    #load_rna_annotated_somatic_variants_to_prod ${run_dir}

    slice_rna_bam_for_hla ${run_dir}

    # Rerun LILAC to produce data on DNA/RNA combined.
    run_lilac_for_actin_run ${run_dir}

    # TODO Try annotate germline VCF on pipeline v5.28

    # Clean up RNA bam
    rm -r ${rna_bam_dir}
fi
