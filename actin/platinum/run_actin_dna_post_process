#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1
source io_functions || exit 1

run_dir=$1 && shift

if [[ -z "${run_dir}" ]]; then
    error "Parameters missing. Exiting.";
fi

# Set the pipeline manually to desired version
pipeline_version_file="${run_dir}/pipeline.version"
if [[ -f "${pipeline_version_file}" ]]; then
    rm "${pipeline_version_file}"
fi
version="5.31"
info "Setting pipeline version to ${version} in ${run_dir}"
echo ${version} >> ${pipeline_version_file}

# Check whether there was an error (potentially present in SAGE 3.0.1)
sage_exception_count=$(cat "${run_dir}/sage_somatic/run.log" | grep -c Exception)
if [[ ${sage_exception_count} -ge 1 ]]; then
    warn "Exceptions found in SAGE run log!"
fi

# Retain original cuppa and clean up in preparation of rerun.
cuppa_dir="${run_dir}/cuppa"
if [[ -d "${cuppa_dir}" ]]; then
    cp -r "${cuppa_dir}" "${run_dir}/cuppa_orig"
    create_or_cleanup_dir "${cuppa_dir}"
fi

# To make sure cuppa is rerun with v1.7.2. Pipeline v5.31 runs v1.7.1
run_cuppa_dna_prod ${run_dir}

# To generate the CUPPA report as a picture (png)
generate_cup_report ${run_dir}

# To generate the CUPPA chart as a picture (png)
# run_cuppa_chart_dna ${run_dir}

# Run ORANGE to pick up all latest versions
run_orange_in_actin_mode ${run_dir}
