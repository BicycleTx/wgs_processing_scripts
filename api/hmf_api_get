#!/usr/bin/env bash

source message_functions || exit 1

api_query=$1 && shift

api_dir="/data/common/dbs/api_credentials"
api_crt="${api_dir}/api.crt"
api_key="${api_dir}/api.key"
api_url="https://api.hartwigmedicalfoundation.nl/hmf/v1"

if [[ -z "${api_query}" || "${api_query}" == "-h" || "${api_query}" == "--help" ]]; then
    echo "---"
    echo "Descr: Runs a GET against HMF API with provided query string and returns JSON."
    echo "Usage: $(basename $0) \${api_query_string}"
    echo "   Eg: $(basename $0) 'samples?name=GIAB12878'"
    echo "       $(basename $0) 'samples?barcode=FR17758478-200806'"
    echo "       $(basename $0) 'runs/63961'"
    echo "       $(basename $0) 'entities?name=HMFreg1000'"
    echo "       all_samples_json=\$($(basename $0) 'samples')"
    echo " Note: Uses URL ${api_url} and creds from ${api_dir}"
    echo "---"
    exit 1
fi

main () {
    request="${api_url}/${api_query}"
    api_curl "${request}" 2>/dev/null
    
    # if first try fails: rerun and write error log to file
    if [[ $? -eq 0 ]]; then
        exit 0
    else
        tmp_err="/tmp/$(basename $0)_fail_$(date '+%Y%m%d_%H%M%S').err"
        api_curl "${request}" 2>"${tmp_err}"
    fi

    # second try
    if [[ $? -eq 0 ]]; then
        # if ok: remove earlier error log and proceed
        rm "${tmp_err}"
        exit 0
    else
        # if still not ok: append request to error log and quit
        err_msg=$(cat "${tmp_err}")
        info "API request that failed: ${request}" >>"${tmp_err}"
        die "GET query '${api_query}' failed (${err_msg})"
    fi
}

api_curl () {
    local url=$1 && shift
    curl --fail --silent --show-error --cert "${api_crt}" --key "${api_key}" \
    -H "Content-Type: application/json" -X GET "${url}"
}

main
