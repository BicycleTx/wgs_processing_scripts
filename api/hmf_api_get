#!/usr/bin/env bash

source message_functions

api_query=$1 && shift

api_dir="/data/common/dbs/api_credentials"
api_crt="${api_dir}/api.crt"
api_key="${api_dir}/api.key"
api_url="https://api.hartwigmedicalfoundation.nl/hmf/v1"

if [[ -z "${api_query}" || "${api_query}" == "-h" || "${api_query}" == "--help" ]]; then
    echo "---"
    echo "Descr: Runs a GET against HMF API with provided query string and returns JSON."
    echo "Usage: $(basename $0) \${api_query_string}"
    echo "   Eg: $(basename $0) 'samples?name=GIAB12878'"
    echo "       $(basename $0) 'samples?barcode=FR17758478-200806'"
    echo "       $(basename $0) 'runs/63961'"
    echo "       $(basename $0) 'entities?name=HMFreg1000'"
    echo "       all_samples_json=\$($(basename $0) 'samples')"
    echo " Note: Uses URL ${api_url} and creds from ${api_dir}"
    echo "---"
    exit 1
fi

main () {
    request="${api_url}/${api_query}"
    api_curl "${request}" 2>/dev/null
    
    # if first time failed: rerun 
    if [[ ! $? -eq 0 ]]; then
        api_curl "${request}" 2>/dev/null
    fi

    # if second time failed: give up
    if [[ ! $? -eq 0 ]]; then
        die "GET query failed '${api_query}'"
    fi
}

api_curl () {
    local url=$1 && shift
    curl --fail --silent --show-error --cert "${api_crt}" --key "${api_key}" \
    -H "Content-Type: application/json" -X GET "${url}"
}

main
