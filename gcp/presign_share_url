#!/usr/bin/env bash

source message_functions || exit 1
source secrets_functions || exit 1

set -e

gcp_url=$1

credentials=$(get_secret_from_secret_manager "gcp-hmf-ops-u-hmf-database")

if [[ -z "$1" || "$1" == "-h" || "$1" == "--help" ]]; then
    error "Usage: $(basename "$0") gs://bucket/path/to_file"
fi

signurl_response=$(gsutil signurl -d 7d <(echo "${credentials}") "${gcp_url}_nope") || die "Unable to sign url (${gcp_url})"
signurl_data=$(echo "${signurl_response}" | grep -A1 ^URL | tail -1)
int_url=$(echo "${signurl_data}" | cut -f1)
expires=$(echo "${signurl_data}" | cut -f3)
ext_url=$(echo "${signurl_data}" | cut -f4)

echo "## File is ${int_url}"
echo "## Expires at ${expires}"
echo "${ext_url}"

