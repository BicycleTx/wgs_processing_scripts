#!/usr/bin/env bash

source message_functions || exit 1

bucket=$1 && shift
set=$1 && shift

[[ -n "${bucket}" ]] || die "No bucket provided. Exiting"
[[ -n "${set}" ]] || die "No set provided. Exiting"

healthchecker_url="gs://${bucket}/${set}/health_checker/"

error=$( gsutil ls ${healthchecker_url} 2>&1)
if [[ "$error" == *"CommandException"* ]]; then
    warn "Run health_checker output does not exist in ${bucket} on gcp."
    exit 1
fi


healthchecker_success=$( gsutil ls ${healthchecker_url} | grep ".HealthCheckSucceeded" | wc -l );
healthchecker_fail=$( gsutil ls ${healthchecker_url} | grep ".HealthCheckFailed" | wc -l )

if [[ ${healthchecker_success} == 0 && ${healthchecker_fail} == 0 ]]; then
   warn "HealthChecker has not been run for ${set}"
elif [[ ${healthchecker_success} == 0 ]]; then
   warn "HealthChecker has failed for ${set}!!"
else
   info "HealthChecker has succeeded for ${set}"
fi
