#!/usr/bin/env bash

source api_functions
source message_functions

biopsy_name=$1 && shift # eg WIDE01010001T
sample_type=$1 && shift # REF or TUM

if [[ -z "${biopsy_name}" ]] || [[ -z "${sample_type}" ]]; then
    die "[ERROR] No biopsy-name and/or sample-type provided to $(basename $0)."
fi

gcp_sign_url_script="generate_signed_gcp_url.py"
gcp_key_file="/data/common/dbs/gcp_credentials/hmf-download"
internal_cram_url=""

if [[ ${sample_type} = "REF" ]]; then
    internal_cram_url=$(locate_reference_cram "${biopsy_name}")
elif [[ ${sample_type} = "TUM" ]]; then
    internal_cram_url=$(locate_tumor_cram "${biopsy_name}")
else
    die "Provided type needs to be REF or TUM"
fi

# Unfortunately the sign script takes URL without "gs://" prefix
# Ideally we use gsutil signurl directly but does not work with requester pays buckets
cram=$(echo "${internal_cram_url}" | sed 's/^gs\:\/\///')
crai=${cram}.crai

internal_crai_url="${internal_cram_url}.crai"
external_cram_url=$(${gcp_sign_url_script} "${gcp_key_file}" "${cram}" 172800)
external_crai_url=$(${gcp_sign_url_script} "${gcp_key_file}" "${crai}" 172800)

info "CRAM internal URL: ${internal_cram_url}"
info "CRAI internal URL: ${internal_crai_url}"
info "CRAM external URL: ${external_cram_url}"
info "CRAI external URL: ${external_crai_url}"