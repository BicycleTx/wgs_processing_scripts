#!/usr/bin/env bash

source api_functions
source message_functions

biopsy_name=$1 && shift # eg WIDE01010001T
sample_type=$1 && shift # REF or TUM

PRESIGN_SECONDS=172800

print_usage(){
    echo "-----"
    echo " Descr: Prints presigned CRAM and CRAI URLs by biopsy name"
    echo " Usage: $(basename $0) \${biopsy-name} \${sample-type}"
    echo "        $(basename $0) CPCT02010003T REF"
    echo "        $(basename $0) CPCT02010003T TUM"
    echo "  Note: URLs will be valid for ${PRESIGN_SECONDS} seconds"
    echo "-----"
    exit 1
}

if [[ -z "${biopsy_name}" ]] || [[ -z "${sample_type}" ]]; then
    print_usage
fi

gcp_sign_url_script="generate_signed_gcp_url.py"
gcp_key_file="/data/common/dbs/gcp_credentials/hmf-download"
internal_cram_url=""

if [[ ${sample_type} = "REF" ]]; then
    internal_cram_url=$(locate_reference_cram "${biopsy_name}")
elif [[ ${sample_type} = "TUM" ]]; then
    internal_cram_url=$(locate_tumor_cram "${biopsy_name}")
else
    die "Provided type needs to be REF or TUM"
fi

# Unfortunately the sign script takes URL without "gs://" prefix
# Ideally we use gsutil signurl directly but does not work with requester pays buckets
cram=$(echo "${internal_cram_url}" | sed 's/^gs\:\/\///')
crai=${cram}.crai

internal_crai_url="${internal_cram_url}.crai"
external_cram_url=$(${gcp_sign_url_script} "${gcp_key_file}" "${cram}" "$PRESIGN_SECONDS")
external_crai_url=$(${gcp_sign_url_script} "${gcp_key_file}" "${crai}" "$PRESIGN_SECONDS")

info "URLs for ${sample_type} sample of biopsy ${biopsy} (valid for ${PRESIGN_SECONDS} seconds):"
info "CRAM internal URL: ${internal_cram_url}"
info "CRAI internal URL: ${internal_crai_url}"
info "CRAM external URL: ${external_cram_url}"
info "CRAI external URL: ${external_crai_url}"