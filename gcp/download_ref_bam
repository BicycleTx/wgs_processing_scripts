#!/usr/bin/env bash

source sbp_api_functions

set=$1 && shift

if [ -z "${set}" ]; then
    echo "[ERROR] No set provided. Exiting."
    exit 1
fi

bucket=$(load_intial_run_bucket_for_set ${set})
if [ -z "${bucket}" ]; then
    echo "[ERROR] No initial run bucket found for set ${set}. Exiting"
    exit 1
fi

gspath=gs://${bucket}/${set}
dspath=/data/gcp/bam_downloads/bams_${set}

sample_id=$(load_ref_sample_id_for_set ${set})

echo "[INFO] Downloading REF bam from ${gspath}"
gcloud auth activate-service-account --key-file=/data/common/dbs/gcp_credentials/hmf-download

bampath=$(gsutil -u hmf-database ls -r ${gspath} | grep -Po "[^\s]*(mapping|aligner)/${sample_id}(_dedup)?(.realigned)?.bam$")

echo ${bampath}
# gsutil -u hmf-database cp gs://${bucket}/${bampath} ${dspath}/
