#!/usr/bin/env bash

print_usage(){
    echo "Usage: make_bucket -n bucket_name -p project_name"
    echo "  -n bucket_name      Name of the bucket to be created"
    echo "  -p project_name     Name of the project in which to create bucket"
    exit 1
}

while getopts ':n:p:' flag; do
  case "${flag}" in
    n) BUCKET_NAME=$OPTARG ;;
    p) PROJECT_NAME=$OPTARG ;;
    *) print_usage
       exit 1 ;;
  esac
done

if [ -z $BUCKET_NAME ] || [ -z $PROJECT_NAME ]
then
    print_usage
fi

echo "Creating bucket in GCP. Disregard warnings about KMS permissions, our storage accounts are authorized."
gsutil mb -c standard -b on -l europe-west4 -p ${PROJECT_NAME} gs://${BUCKET_NAME}
gsutil kms encryption -w -k projects/hmf-database/locations/europe-west4/keyRings/hmf-database/cryptoKeys/hmf-database-20191001 gs://${BUCKET_NAME}