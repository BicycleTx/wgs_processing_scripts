#!/usr/bin/env bash

source message_functions || exit 1

MIN_ARRIVAL_DATE="2022-01-01"
LAMA_API_URL="http://lama-preview.prod-1/api"
REPORT_SHARED_TSV="/data/ops/lims/prod/sharing_db_generated.tsv"
UNREPORTABLE_TSV="/data/ops/lims/prod/samples_without_pdf_report.tsv"

info "Retrieving samples from LAMA with arrival date [$MIN_ARRIVAL_DATE] or later"
info "  LAMA url: $LAMA_API_URL"
samples=$(curl --silent "${LAMA_API_URL}/tumor-samples/arrival?start-date=${MIN_ARRIVAL_DATE}")
sample_count=$(jq 'length' <<< "$samples")

function main (){
    info "Starting unreported check for $sample_count samples"
    counter=0
    jq -c '.[]' <<< "$samples" | while read -r sample_info; do
        counter=$((counter+1))
        sampleId=$(jq -r '.sampleId' <<< "$sample_info")
        [[ $((counter%50)) == "0" ]] && info "At sample [$counter] of [$sample_count]"
        report_count=$(grep -cE "${sampleId}\W+" "$REPORT_SHARED_TSV")
        if [[ "$report_count" -lt 1 ]]; then
            check_unreported_sample "$sampleId"
        fi
    done
    info "Finished with unreported check"
}

function check_unreported_sample() {
    local sampleId=$1 && shift

    api_info=$(hmf_api_get "samples?name=${sampleId}&type=tumor")
    api_sample_status=$(jq -r '.[-1].status' <<< "$api_info")
    lama_info=$(curl --silent "${LAMA_API_URL}/statuses?sampleId=${sampleId}")
    # LAMA API has no filter on type currently so need to use jq for now
    lama_status=$(jq '[.[] | select(.type=="TUMOR_TISSUE")]' <<< "$lama_info")
    isolation_failed=$(jq '[.[] | select(.isolationStatus=="FAILED_FINAL")] | length > 0' <<< "$lama_status")
    libraryprep_finished=$(jq '[.[] | select(.libraryPrepStatus=="FINISHED")] | length > 0' <<< "$lama_status")
    unreportable_count=$(grep -cE "^${sampleId}$" "$UNREPORTABLE_TSV")
    info="$sampleId"

    if [[ "$unreportable_count" -gt 0 ]]; then
        info "SKIPPING: Sample is deemed un-reportable [$info]"
    elif [[ "$isolation_failed" == "true" ]]; then
        warn "TO CHECK: Sample has final failed isolation [$info]"
    elif [[ "$libraryprep_finished" == "false" ]]; then
        info "SKIPPING: Sample has no finished library prep (yet) [$info]"
    elif [[ "$api_sample_status" == "Expected" ]]; then
        info "SKIPPING: Sample has finished prep but ignorable api status $api_sample_status [$info]"
    else
        run_info=$(api -j runs "sample_name=${sampleId}" | jq -r '.[]|select(.context=="DIAGNOSTIC")|.set.name+" ("+.status+")"' | tail -1)
        warn "TO CHECK: Sample has finished prep and non-ignorable api status $api_sample_status [$info]"
        warn "  \_ Most recent run: $run_info"
    fi
}

main