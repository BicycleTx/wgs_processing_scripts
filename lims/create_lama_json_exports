#!/usr/bin/env bash

set -e

BUCKET="lama-export"
TMP_DIR="./mongo-dump-tmp"
USER="importExportUser"
COLLECTIONS=(Patients SampleStatus Isolations LibraryPreps SnpChecks Cohorts Hospitals)

echo "[INFO] Retrieving secret"
PASSWORD=$(gcloud secrets versions access "latest" --secret="lama-import-export" --project=hmf-secrets)

echo "[INFO] Creating temp dir $TMP_DIR"
mkdir $TMP_DIR

for collection in "${COLLECTIONS[@]}"; do
    echo "[INFO] Exporting LAMA collection ${collection}..."
    out_dir="${TMP_DIR}/PatientExport.json"
    mongoexport --host lama.mongo.prod-1 --db LAMA -c Patients --out "${out_dir}" --jsonArray --username="$USER" --password="$PASSWORD"
done

echo "[INFO] Uploading $TMP_DIR contents to bucket $BUCKET"
gsutil cp "$TMP_DIR/*.json" "gs://$BUCKET/"

echo "[INFO] Removing $TMP_DIR"
rm -r $TMP_DIR