#!/usr/bin/env bash

set -e

BUCKET="lama-export"
TMP_DIR="./mongo-dump-tmp"
USER="importExportUser"
COLLECTIONS=(Patients SampleStatus Isolations LibraryPreps SnpChecks Cohorts Hospitals)

echo "[INFO] Retrieving secret"
PASSWORD=$(gcloud secrets versions access "latest" --secret="lama-import-export" --project=hmf-secrets)

echo "[INFO] Creating temp dir $TMP_DIR"
mkdir $TMP_DIR

for collection in "${COLLECTIONS[@]}"; do
    out_file="${TMP_DIR}/${collection}.json"
    echo "[INFO] Exporting LAMA collection ${collection} to ${out_file}..."
    mongoexport --host=lama.mongo.prod-1 --db=LAMA --username="$USER" --password="$PASSWORD" --jsonArray \
        --collection="${collection}" --out="${out_file}"
done

echo "[INFO] Uploading $TMP_DIR contents to bucket $BUCKET"
gsutil -m cp "$TMP_DIR/*.json" "gs://$BUCKET/"

echo "[INFO] Removing $TMP_DIR"
rm -r $TMP_DIR