#!/usr/bin/env bash

lims_dir="/data/ops/lims/pilot"
code_dir="/data/common/repos/scripts/lims"

back_dir="${lims_dir}/backup"
out_json="${lims_dir}/lims.json"
log_file="${lims_dir}/update.log"

mod_date=$(date -r "${out_json}" "+%Y-%m-%d %H:%M:%S")
run_date=$(date "+%Y-%m-%d %H:%M:%S")

echo "===== Running $(basename $0) =====" 2>&1 | tee -a ${log_file}
echo "[INFO] LastMod date: ${mod_date}" 2>&1 | tee -a ${log_file}
echo "[INFO] Current date: ${run_date}" 2>&1 | tee -a ${log_file}

if [[ -f "${out_json}" ]]; then
    echo "[INFO] Backing up ${out_json}"
    cp "${out_json}" "${back_dir}"
fi

${code_dir}/convert_lims_data_pilot.pl \
    -lims_dir "${lims_dir}" \
    -out_json "${out_json}" \
    2>&1 | tee -a ${log_file}
