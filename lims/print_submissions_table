#!/usr/bin/env bash

LIMS_JSON_FILE="/data/ops/lims/prod/lims.json"
SUBMISSIONS_JSON="$(cat "${LIMS_JSON_FILE}" | jq -c '.submissions')"

submissions_to_visit=("$@") # optional

if [[ "$#" -eq 0 ]]; then
    submissions_to_visit=( $(echo "${SUBMISSIONS_JSON}" | jq -r 'keys[]' | sort -r | head -100) )
fi

for submission in "${submissions_to_visit[@]}"; do
    obj_json=$(echo "${SUBMISSIONS_JSON}" | jq ".${submission}")
    project_name=$(echo "${obj_json}" | jq -r ".project_name")
    project_type=$(echo "${obj_json}" | jq -r ".project_type")
    expected_sample_count=$(echo "${obj_json}" | jq -r ".sample_count")
    analysis_type=$(echo "${obj_json}" | jq -r ".analysis_type")

    ## reset some fields according to project type
    if [[ "${project_type}" == "Human research" ]]; then
        project_type="HUM-RES"
    elif [[ "${project_type}" == "non human research" || "${project_type}" == "Non human research" ]]; then
        project_type="NONHUM-RES"
    elif [[ "${project_type}" == "KG production" ]]; then
        project_type="KG"
    elif [[ "${project_type}" == "CORE" ]]; then
        analysis_type="SomaticAnalysis"
    elif [[ "${project_type}" == "Cohort" ]]; then
        analysis_type="NA"
    else
        project_type="CheckProjectType(${project_type})"
    fi

    ## output
    printf "%s\t%s\t%s\t%s\t%s\n" \
        "${submission}" \
        "${project_name}" \
        "${project_type}" \
        "${analysis_type}" \
        "${expected_sample_count}"
done
