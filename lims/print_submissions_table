#!/bin/bash

SUBMISSIONS=("$@") # optional
JSON=/data/lims/submissions.json
na="NA"

if [ "$#" -eq 0 ]; then
  SUBMISSIONS=( $( cat $JSON | jq -r 'keys[]' | sort -r | head -100 ) )
fi

for submission in "${SUBMISSIONS[@]}"; do 

  MAINKEY=".${submission}"
  
  ## init
  mail=$na; name=$na; subm=$na; pNam=$na; pTyp=$na
  cntr=$na; enti=$na; buck=$na; aTyp=$na; amnt=$na
  
  ## retrieve info
  mail=$( cat ${JSON} | jq -r "${MAINKEY}.contact_email" )
  name=$( cat ${JSON} | jq -r "${MAINKEY}.contact_name" )
  subm=$( cat ${JSON} | jq -r "${MAINKEY}.submission" )
  pNam=$( cat ${JSON} | jq -r "${MAINKEY}.project_name" )
  pTyp=$( cat ${JSON} | jq -r "${MAINKEY}.project_type" )
  aTyp=$( cat ${JSON} | jq -r "${MAINKEY}.analysis_type" )
  amnt=$( cat ${JSON} | jq -r "${MAINKEY}.sample_count" )
  cntr=$( echo $pNam | cut -d"-" -f1 )

  ## fix project type (rename to short versions)
  if   [[ $pTyp == "Human research" ]]; then pTyp="HUM-RES"
  elif [[ $pTyp == "non human research" || $pTyp == "Non human research" ]]; then pTyp="NONHUM-RES"
  elif [[ $pTyp == "KG production" ]]; then pTyp="KG"
  elif [[ $pTyp == "CORE" ]]; then pTyp="CORE"
  else pTyp="UnknownType"
  fi

  ## check entitiy existance and fix for KG
  bucketBySubmission=$( query_sbp_api -type entities -json | jq -r ".[] | select( .name == \"${subm}\" ) | .bucket" )
  if   [[ $pTyp == "KG" ]]; then enti="KG_${cntr}"; buck=$bucketBySubmission
  elif [[ ! -z $bucketBySubmission ]]; then enti=$subm; buck=$bucketBySubmission
  else enti="UnknownEntitiy"; buck="UnknownBucket"
  fi

  ## output
  printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n" "$subm" "$pNam" "$name" "$pTyp" "$enti" "$buck" "$aTyp" "$amnt"

done
