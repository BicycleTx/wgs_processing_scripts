#!/usr/bin/env bash

source message_functions || exit 1

barcode=$1
JSON1=${2:-"/data/ops/lims/prod/lims.json"}
JSON2=${3:-"/data/ops/lims/pilot/lims.json"}
ONLY_IMPORTANT_FIELDS=${4:-"false"}
IMPORTANT_FIELDS=(
analysis_type arrival_date biopsy_site entity hospital_pa_sample_id hospital_patient_id is_cup
isolation_id isolation_experiment_id isolation_status lab_sop_versions lab_status label
patient prep_id prep_type project_name ptum ref_sample_id
report_conclusion report_germline report_germline_level report_pgx report_viral
reporting_id sample_name sample_id sampling_date shallowseq submission yield
)

main (){
    info "Diffing one sample"
    info "  LIMS json 1: ${JSON1}"
    info "  LIMS json 2: ${JSON2}"
    info "  Barcode: ${barcode}"
    diff_barcode "${barcode}"
}

diff_barcode() {
    local barcode=$1 && shift

    one=$(query_lims.pl -lims "${JSON1}" -type "samples" -filter "sample_id=${barcode}" -exact -json) \
      || die "Querying LIMS JSON 1 failed ($barcode)"
    two=$(query_lims.pl -lims "${JSON2}" -type "samples" -filter "sample_id=${barcode}" -exact -json) \
          || die "Querying LIMS JSON 2 failed ($barcode)"

    if [[ "$ONLY_IMPORTANT_FIELDS" == "true" ]]; then
        partial_diff "$barcode" "$one" "$two"
    else
        complete_diff "$barcode" "$one" "$two"
    fi

}

partial_diff() {
    local barcode=$1 && shift
    local json1=$1 && shift
    local json2=$1 && shift
    for key in "${IMPORTANT_FIELDS[@]}"; do
        val1=$(jq -r --arg key "${key}" '.[-1][$key]' <<< "${json1}")
        val2=$(jq -r --arg key "${key}" '.[-1][$key]' <<< "${json2}")
        outcome="NA"
        if [[ "${val1}" == "${val2}" ]]; then
            outcome="OK"
        else
            outcome="FAIL"
        fi
        printf "%s\t%s\t%s\t%s\n" "${outcome}" "${key}" "${val1}" "${val2}"
    done
}

complete_diff() {
    local barcode=$1 && shift
    local json1=$1 && shift
    local json2=$1 && shift
    diff_count=$(diff -y <(jq -S <<< "${json1}") <(jq -S <<< "${json2}") | wc -l | tr -d " ")
    if [[ "${diff_count}" -eq 0 ]]; then
        info "  DIFF OK (${diff_count} diff for ${barcode})"
    else
        warn "  DIFF FAIL (${diff_count} diff for ${barcode})"
        diff <(jq -S <<< "${json1}") <(jq -S <<< "${json2}")
    fi
}

main