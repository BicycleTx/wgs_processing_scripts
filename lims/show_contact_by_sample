#!/usr/bin/env bash

source message_functions || exit 1

sample_name=$1

# get sample
info "Searching LIMS for samples with name ${sample_name}"
samples=$(query_lims.pl -type samples -filter "sample_name=${sample_name}" -exact -json)
sample_count=$(jq 'length' <<< "${samples}")
if [[ "$sample_count" == 0 ]]; then
    die "No samples found"
elif [[ "$sample_count" > 1 ]]; then
    warn "More than 1 sample found. Using last one."
fi
sample=$(jq '.[-1]' <<< "${samples}")
submission_id=$(jq -r '.submission' <<< "${sample}")

# get submission
info "Searching LIMS for submission with id ${submission_id}"
submission=$(query_lims.pl -type submissions -filter "submission=${submission_id}" -exact -json | jq '.[-1]')
group_id=$(jq -r '.group_id' <<< "${submission}")

# get group
info "Searching LIMS for groups with id ${group_id}"
contact_groups=$(query_lims.pl -type contact_groups -filter "group_id=${group_id}" -exact -json)
group_count=$(jq 'length' <<< "${contact_groups}")

if [[ "${group_count}" == 0 ]]; then
    die "No groups found for submission '${submission_id}'"
fi
contact_group=$(jq '.[-1]' <<< "${contact_groups}")

info "Sample $sample_name with submission $submission_id is linked to contact group $group_id"
echo "$contact_group"
