source locate_files || exit 1
source message_functions || exit 1

info "Run PEACH tests"

if [[ $# -eq 0 ]]; then
  venv_dir=$(locate_pgx_venv_dir)
else
  venv_dir=$1 && shift
fi

# peach_repo_base_dir=$HOME/repos/scripts/pgx
peach_repo_base_dir=$(locate_pgx_dir)

# START VIRTUAL ENV
source "${venv_dir}/bin/activate" || die "Could not activate PEACH venv"

export PYTHONPATH="${PYTHONPATH}:${peach_repo_base_dir}/src/"
export MYPYPATH="${MYPYPATH}:${peach_repo_base_dir}/src/"

python -m unittest discover --buffer --verbose --start-directory "${peach_repo_base_dir}" || die "Some PEACH tests failed"

info "PEACH tests succeeded"

mypy_config="${peach_repo_base_dir}/mypy.ini"

info "Run PEACH type check"

mypy "${peach_repo_base_dir}/src" --config-file "${mypy_config}" --namespace-packages --explicit-package-bases || die "PEACH type check failed"

info "PEACH type succeeded"
