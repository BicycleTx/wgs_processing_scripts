#!/usr/bin/env bash

source locate_files || exit 1
source message_functions || exit 1
source metadata_functions || exit 1

info "Start running PGX pilot script"

run_dir=$1 && shift

if [[ $# -eq 0 ]]; then
  venv_dir=$(locate_pgx_venv_dir)
else
  venv_dir=$1 && shift
fi

# START VIRTUAL ENV
source "${venv_dir}/bin/activate" || die "Could not activate PGX venv"

output_dir=${run_dir}/pgx_pilot

version_pgx_tool=$(echo "pilot" | tr "_" " " | tr "v" " "| awk '{print $1}')

ref_sample=$(load_ref_sample_from_metadata "${run_dir}")
tumor_sample=$(load_tumor_sample_from_metadata "${run_dir}")

if [[ -d "${output_dir}" ]]; then
    rm -r "${output_dir}"
    info "[INFO] PGX pilot dir exist. PGX dir is just removed and will be replaced"
fi

germline_vcf=$(locate_germline_variants "${run_dir}" "${ref_sample}")

# REFERENCES
pgx_tool=$(locate_pgx_main)
pgx_resource_dir=$(locate_pgx_resource_dir)
vcftools_tool=$(locate_vcftools)

# RUN
python "${pgx_tool}" "${germline_vcf}" "${tumor_sample}" "${ref_sample}" "${version_pgx_tool}" "${output_dir}"  \
    --panel "${pgx_resource_dir}/panelfiles/DPYD.json" \
    --sourcedir "${pgx_resource_dir}" \
    --vcftools "${vcftools_tool}"
