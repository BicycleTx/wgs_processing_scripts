#!/usr/bin/env bash

source message_functions

if [[ "$(hostname)" != "datastore" ]]; then
    echo "[ERROR] This script is meant to be executed at datastore. Exiting."
    exit 1
fi

for i in {2,3}; do
    ssh crunch00${i} check_samplesheets | \
    grep -Po "(X|NO|NS|IS)\d{2}\-.+_.+_.+_.+" | \
    while read crunch_info; do
        fc_run_name=$(echo "${crunch_info}" | cut -f1)
        fc_dir_name=$(echo "${crunch_info}" | cut -f2)
        fc_run_date=$(echo "${fc_dir_name}" | cut -d"_" -f1)

        query="flowcells?name=${fc_run_name}"
        response=$(hmf_api_get "${query}")
        gcp_info="GCP=Unknown"
        if [[ $(echo "${response}" | jq length) -eq 1 ]]; then
            gcp_status=$(echo "${response}" | jq -r '.[-1].status')
            gcp_qc=$(echo "${response}" | jq -r '.[-1].undet_rds_p_pass')
            gcp_info="GCP=${gcp_status}(qc=${gcp_qc})"
        fi
        echo -e "${fc_run_date}\t${crunch_info},${gcp_info}"
    done     
done | sort -r -k1 -k2 | cut -f2-
