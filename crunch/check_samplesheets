#!/bin/bash
run=$1

if [[ ! $run == "" ]]; then
    sheets=$run"/SampleSheet.csv"
else
    sheets="/data1/illumina_data/*/SampleSheet.csv"
fi
    
for sheet in $sheets; do 
	currHost=`hostname`
	currHostShort=`echo $currHost | sed 's/crunch00/c/g'`
	runBase=`dirname $sheet`
	runName=`basename $runBase`
	readmeFile=$runBase"/README"
        conversionLogFile=$runBase"/conversionLog.txt"
	sampleSheetFile=$runBase"/SampleSheet.csv"
	experimentName=`cat $sheet | grep "ExperimentName" | cut -d',' --output-delimiter ": " -f 2`
	
	echo ""
	#echo "# ----- HMFreg";
	echo "# "$currHost;
	echo "# [Rund] "$runBase;
	echo "# [Samp] "$sampleSheetFile;
	
	## check cycle status
	cycleCount=`ls $runBase/Logs/ | grep -Pc "Cycle "`
	echo "# [NOTE] CYCLE log count: $cycleCount"
		
        ## check conversion status
        if [ ! -e $conversionLogFile ]; then
		echo "# [NOTE] CONVERSION not started yet";
	elif [ $((`cat $conversionLogFile | wc -l`%2)) -eq 0 ]; then
		echo "# [NOTE] CONVERSION appears to be FINISHED";
	else
		currLane=`ls $runBase/Data/Intensities/BaseCalls/Undetermined*gz | grep -Po "L\d{3}" | sort | uniq | tail -1`
		echo "# [NOTE] CONVERSION appears to be RUNNING ($currLane)";
	fi

	## check images presence
	if [ -d "$runBase/Thumbnail_Images/L001" ]; then
		echo "# [NOTE] IMAGES are still present";
	fi

	## print readme file path if present
	if [ -e $readmeFile ]; then
		echo "# [README] $readmeFile";
	fi

	## print line that can be pasted directly into RunOverview sheet
	echo -e "# $experimentName\t$runName\tseq\t$currHostShort";

	## print sample-id, sample_name, submission-id, description
	cat $sheet | sed -e '1,/Lane,Sample_ID/d' | cut -d',' --output-delimiter " " -f2,3,8,9 | sort | uniq; 
done
