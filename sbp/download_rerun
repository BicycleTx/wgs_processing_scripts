#!/bin/bash

script=$( basename $0 )
awscmd='sbp'
awsprofile='download'
storepath='/data/schuberg/merged_runs'

usage() {
    echo "---"
    echo "Usage: $script -s <setname> -r <rerun_bucket> [-l <localpath> -c <awscmd> -p <awsprofile>]" 1>&2;
    echo "       $script -s 170101_HMFreg0000_etc -o hmf-output-2016-11 -r hmf-output-2017-09 [-l ${storepath} -c ${awscmd} -p ${awsprofile}]" 1>&2;
    echo "---"
    exit 1
}

while getopts ":s:o:r:l:c:p:" o; do
    case "${o}" in
        s)
            setname=${OPTARG} || usage
            ;;
        r)
            rerunbucket=${OPTARG}
            ;;
        l)
            storepath=${OPTARG}
            ;;
        c)
            awscmd=${OPTARG}
            ;;
        p)
            awsprofile=${OPTARG}
            ;;

        *)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

## check required params
if [[ -z "${setname}" || -z "${rerunbucket}" ]]; then
    usage
fi

## making sure no slashes are present
rerunbucket=$( basename ${rerunbucket} )
setname=$( basename ${setname} )

## build path from current archive bucket
reruns3path="s3://${rerunbucket}/${setname}"
localpath="${storepath}/${setname}"

## print feedback and run
echo "## [INFO] Starting sync for ${setname}"
echo "## [INFO] To: ${localpath}"
echo "## [INFO] Rerun from: ${reruns3path}"

## rerun sync
${awscmd} s3 sync ${reruns3path} ${localpath} --profile ${awsprofile} \
--exclude "*" \
--include "metadata" \
--include "amber/*" \
--include "cobalt/*" \
--include "somaticVariants/*post_processed*" \
--include "structuralVariants/manta/*somaticSV.vcf.gz*" \
--include "structuralVariants/bpi/*sliced.bam*" \
--include "structuralVariants/bpi/*.tsv"


