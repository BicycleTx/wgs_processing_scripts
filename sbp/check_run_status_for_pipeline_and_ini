#!/usr/bin/env bash

ini=$1
pip=$2

if [[ -z ${ini} ]]; then echo "[EXIT] No ini given" & exit 1; fi
if [[ -z ${pip} ]]; then echo "[EXIT] No pipeline version given" & exit 1; fi

## STLI: param check
iniCount=$( query_sbp_api -type inis -filter "name=${ini}" -exact | grep -v "^#" | wc -l )
if [[ ${iniCount} != 1 ]]; then
    echo "[EXIT] Error: incorrect ini ${ini})?" && exit 1
fi
pipCount=$( query_sbp_api -type stacks -filter "revision=${pip}" -exact | grep -v "^#" | wc -l )
if [[ ${pipCount} < 1 ]]; then
    echo "[EXIT] Error: incorrect pipeline version (${pip})?" && exit 1
fi

## STLI: define setting by ini
findDirs="/data/cpct/runs/ /data/schuberg/processed_runs/ /data/schuberg/cpct_drup_downloads_v4/ /data/cpct/reruns_v4/"
findDirsFail="/data/schuberg/qc_fail_runs"
downloadScript="process_finished_run"
downloadScriptFail="download_qc_fail_run"
if [[ ${ini} =~ Rerun ]]; then
    findDirs="/data/cpct/reruns_v4/ /data/schuberg/reruns_v4/"
    downloadScript="download_rerun_v4_set -s"
fi

## STLI: perform job
echo "## Failed runs with ini ${ini} and pipeline ${pip} which are expected to exist on datastore"
allValidatedRuns=$(query_sbp_api -type runs -filter "ini=${ini}" --filter "bucket=hmf-output" -filter "pipeline=${pip}" -filter "status=Validated" -json | jq -r '.[].tumor_sample')
query_sbp_api \
    -type runs \
    -filter "ini=${ini}" \
    -filter "bucket=hmf-output" \
    -filter "pipeline=${pip}" \
    -filter "status=Failed" \
    -json | jq -r '.[].tumor_sample' | uniq | \
    while read failedTumorSample; do
        foundValue=$( echo ${allValidatedRuns} | tr " " "\n" | grep -w  ${failedTumorSample} | wc -l)
        bucketSet=$( query_sbp_api -type runs -filter "tumor_sample=${failedTumorSample}" -filter "ini=${ini}" -filter "pipeline=${pip}" -filter "status=Failed" -exact -json | jq -r '.[].bucket' | grep "hmf-output" | tail -n 1)
        if [[ ${foundValue} == 0 ]]
        then
             failedSet=$( query_sbp_api -type runs -filter "tumor_sample=${failedTumorSample}" -filter "ini=${ini}" -filter "bucket=${bucketSet}" -filter "pipeline=${pip}" -filter "status=Failed" -exact -json | jq -r '.[].name' | tail -n 1 )
             COUNT=$( find ${findDirs} -maxdepth 1 -type d -name "${failedSet}" | wc -l);
		     CountFailedSet=$( find ${findDirsFail} -maxdepth 1 -type d -name "${failedSet}" | wc -l)
		     if [[ ${COUNT} == 0 && ${CountFailedSet} == 0 ]]
		     then
			    bucketSetFail=$( query_sbp_api -type runs -filter "tumor_sample=${failedTumorSample}" -filter "ini=${ini}" -filter "bucket=${bucketSet}" -filter "pipeline=${pip}" -filter "status=Failed" -exact -json | jq -r '.[].bucket' | tail -n 1)
                echo "${downloadScriptFail} -s ${failedSet} -b ${bucketSetFail}"
		     elif [[ ${COUNT} == 0 ]]
             then
                echo "${failedSet} has failed on ${pip} and is already on datastore ${findDirsFail}"
             fi
        fi
    done | sort -r | uniq
echo ""

echo "## Validated runs with ini ${ini} and pipeline ${pip}"
query_sbp_api \
    -type runs \
    -filter "ini=${ini}" \
    -filter "bucket=hmf-output" \
    -filter "pipeline=${pip}" \
    -filter "status=Validated" \
    -json | jq -r '.[].name' | \
    while read setName; do
        COUNT=$( find ${findDirs} -maxdepth 1 -type d -name "${setName}" | wc -l);
        if [[ ${COUNT} == 0 ]]
        then
            echo "${downloadScript} ${setName}"
        else
            echo "# No action for ${setName}: already exists on datastore"
        fi
    done | sort -r | uniq
echo ""

echo "## SnpCheck runs with ini ${ini} and pipeline ${pip}"
query_sbp_api \
    -type runs \
    -filter "ini=${ini}" \
    -filter "bucket=hmf-output" \
    -filter "pipeline=${pip}" \
    -filter "status=SnpCheck" \
    -json | jq -r '.[].name' | \
    while read setName; do
        COUNT=$( find ${findDirs} -maxdepth 1 -type d -name "${setName}" | wc -l);
        if [[ ${COUNT} == 0 ]]
        then
            echo "${downloadScript} ${setName}"
        else
            echo "# No action for ${setName}: already exists on datastore"
        fi
    done | sort -r | uniq
echo ""

echo "## Processing (or downloading/uploading) runs with ini ${ini} and pipeline ${pip}"
query_sbp_api \
    -type runs \
    -filter "ini=${ini}" \
    -filter "pipeline=${pip}" \
    -filter "status=Processing|Downloading|Uploading" \
    -json | jq -r '.[].name' | \
    while read setName; do
        echo "${setName} is processing (or downloading/uploading) on ${pip}"
    done | sort -r | uniq
echo ""

echo "## Pending runs with ini ${ini} and pipeline ${pip}"
query_sbp_api \
    -type runs \
    -filter "ini=${ini}" \
    -filter "pipeline=${pip}" \
    -filter "status=Pending" \
    -json | jq -r '.[].name' | \
    while read setName; do
        echo "${setName} is pending on ${pip}"
    done | sort -r | uniq
echo ""