#!/usr/bin/env bash

archive_path="/data/data_archive/shallow_seq_pipelines"
download_path="/data/schuberg/shallow_runs"
bucket="hmf_experiments"

usage() {
    echo "---"
    echo "Usage: $(basename $0) -s <SetName>" 1>&2;
    echo "       $(basename $0) -s 190101_ShallowSeq_etc (uses bucket $bucket)" 1>&2;
    echo "       $(basename $0) -s 190101_ShallowSeq_etc -b <bucket>" 1>&2;
    echo "---"
    exit 1
}

while getopts ":s:b:" o; do
    case "${o}" in
        s)
            set=${OPTARG} || usage
            ;;
        b)
            bucket=${OPTARG} || usage
            ;;
        *)
            usage
            ;;
    esac
done

if [[ -z "${set}" ]]; then
    usage
fi

archive_set_path=${archive_path}/${set}

if [[ -d ${archive_set_path} ]]; then
    echo "[WARN] SKIPPING: Set already archived locally (${archive_set_path})"
else
    echo "[INFO] Syncing set ${set} from bucket (${bucket}) to ${download_path}"
    download_set_path=${download_path}/${set}
    sbp s3 sync s3://${bucket}/${set}/ ${download_set_path}/ \
        --exclude "*.bam" \
	      --profile download
fi
