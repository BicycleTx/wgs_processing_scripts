#!/usr/bin/env bash

RUN_NAME=$1
LOCAL_DIR=/data/schuberg/${RUN_NAME}

sbp_new s3 sync "s3://${OUTPUT_BUCKET}/${RUN_NAME}/" "${LOCAL_DIR}/" --profile download_new

VERIFY_LOGFILE="${LOCAL_DIR}/logs/verify_s3_md5.log"

# only verify on the second run to avoid running twice and ensure error message goes to check file
if [ -f "${VERIFY_LOGFILE}" ] && [ ! -s "${VERIFY_LOGFILE}" ]; then
    verify_s3_md5 --local-path "${LOCAL_DIR}" --remote-url "s3://${OUTPUT_BUCKET}" --check-links > "${VERIFY_LOGFILE}" 2>&1 \
        || echo "ERROR: verify_s3_md5 failed, check ${VERIFY_LOGFILE}"
else
    touch "${VERIFY_LOGFILE}"
fi
