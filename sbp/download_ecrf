#!/bin/bash
ecrf_folder="/data/ecrf/"
# MIVO: assumes the folder contains only one file
file=$(sbp s3 ls "$1" --profile hmf_owncloud | awk -F ' ' 'FNR == 2 {s = ""; for (i = 4; i <= NF-1; i++) s = s $i " "; print s $NF}')
s3_file_size=$(sbp s3 ls "$1" --profile hmf_owncloud | awk -F ' ' 'FNR == 2 {print $3}')
# MIVO: match the last 6 numbers from the end of the file names; 
#       assumes the file names end with 8 numbers (representing the date in format YYYYMMDD) followed by the file extension (.xml)
#       example file name: ODM Patientdata_20170421.xml
date=$(expr match "$file" '.*\([0-9]\{6\}\)') 
xml_path="$ecrf_folder${date}_$2.xml"
if [ ! -f $xml_path ]; then
   echo "Copying $1$file to $xml_path"
   sbp s3 cp "$1${file}" "${xml_path}" --profile hmf_owncloud 
   local_file_size=$(stat -c%s "${xml_path}")
   echo "Checking file sizes. s3: $s3_file_size; local: $local_file_size"  
   if [ $s3_file_size -eq $local_file_size ]; then
      echo "File sizes equal. Deleting $1${file}"
      sbp s3 rm "$1${file}" --profile hmf_owncloud
      echo "$xml_path OK"
   else
      echo "Skipped deleting $1${file}(file sizes were not equal)"
   fi
else
   echo "$xml_path Skipped(already exists)"
fi
