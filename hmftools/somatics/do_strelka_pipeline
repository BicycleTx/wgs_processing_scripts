#!/bin/bash
source load_metadata
run_dir=$1 && shift

#### Tools
tabix=/data/common/tools/tabix_v0.2.6/tabix

#### Output Directories
sample=$(load_tumor_sample_from_metadata ${run_dir})
joint_name=$(load_joint_name_from_metadata ${run_dir})
output_dir=${run_dir}/somaticVariants/${joint_name}
working_dir=${output_dir}/postStrelka
mkdir -p ${working_dir}

#### Output Files
merged_vcf=${working_dir}/merged.vcf
post_processed_vcf=${working_dir}/post_processed.vcf
mnv_vcf=${working_dir}/mnv.vcf
snpEff_vcf=${working_dir}/snpEff.vcf
snpEff_vcf_gz=${snpEff_vcf}.gz
annotated_vcf_gz=${working_dir}/annotated.vcf.gz
final_vcf_gz=${output_dir}/${joint_name}_post_processed.v2.vcf.gz

#### Execution
do_strelka_merge ${run_dir} ${merged_vcf}
do_strelka_post_process ${sample} ${merged_vcf} ${post_processed_vcf}
do_strelka_mnv ${sample} ${post_processed_vcf} ${mnv_vcf}
do_strelka_snpeff ${sample} ${mnv_vcf} ${snfEff_vcf}

bgzip ${snfEff_vcf}
${tabix} -p vcf ${snpEff_vcf_gz}

do_strelka_annotation ${snpEff_vcf_gz} ${annotated_vcf_gz}
do_strelka_pon_filter ${annotated_vcf_gz} ${final_vcf_gz}


echo "Complete -" $(date)

#do_strelka_merge \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/ \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/merged.vcf

#do_strelka_post_process \
#    CPCT02290017T \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/merged.vcf \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/post_processed.vcf

#do_strelka_mnv \
#    CPCT02290017T \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/post_processed.vcf \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/mnv.vcf

#do_strelka_snpeff \
#    CPCT02290017T \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/mnv.vcf \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/snpEff.vcf

#do_strelka_annotation \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/snpEff.vcf.gz \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/annotated.vcf.gz

#do_strelka_pon_filter \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/postStrelka/annotated.vcf.gz \
#    /data/cpct/runs/171029_HMFregCPCT_FR15414420_FR15414585_CPCT02290017/somaticVariants/CPCT02290017R_CPCT02290017T/CPCT02290017R_CPCT02290017T_post_processed.v2.vcf.gz