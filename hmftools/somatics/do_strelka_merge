#!/bin/bash
source load_metadata

run_dir=$1 && shift
output_vcf=$1 && shift

### Dependencies
bcftools=/data/common/tools/bcftools_v1.3/bcftools
hotspot=/data/common/dbs/somatic_hotspot/Hotspot.tsv.gz
gatk=/data/common/tools/gatk_v3.4.46-hmf
ref_genome=/data/common/refgenomes/Homo_sapiens.GRCh37.GATK.illumina/Homo_sapiens.GRCh37.GATK.illumina.fa
strelka_post_process_jar=/data/common/tools/strelka-post-process_v1.0/strelka-post-process.jar

### Input Files
indels=$(ls ${run_dir}/somaticVariants/*/strelka/results/all*indels.vcf)
snvs=$(ls ${run_dir}/somaticVariants/*/strelka/results/all*snvs.vcf)

if [[ ! -e ${output_vcf} ]]
then
    indels_passed=${output_vcf}.indels
    snvs_passed=${output_vcf}.snvs

    ### Hotspots
    echo "Annotate and filter INDEL hotspots -" $(date)
    ${bcftools} annotate -a ${hotspot} -c CHROM,POS,REF,ALT -m +HOTSPOT ${indels} -O u | \
    ${bcftools} filter -e HOTSPOT=1 -s PASS -O u | \
    ${bcftools} filter -i 'FILTER="PASS"' -o ${indels_passed}

    echo "Annotate and filter SNV hotspots -" $(date)
    ${bcftools} annotate -a ${hotspot} -c CHROM,POS,REF,ALT -m +HOTSPOT ${snvs} -O u | \
    ${bcftools} filter -e HOTSPOT=1 -s PASS -O u | \
    ${bcftools} filter -i 'FILTER="PASS"' -o ${snvs_passed}

    ### Combine
    echo "Combine variants"
    java -jar "${gatk}/GenomeAnalysisTK.jar" \
        -T CombineVariants \
        -R ${ref_genome} \
        --genotypemergeoption unsorted \
        -V:snvs ${snvs_passed} \
        -V:indels ${indels_passed} \
        -o ${output_vcf}

    ### Clean up
    #rm -f ${indels_passed}*
    #rm -f ${snvs_passed}*
else
       echo "${output_vcf} already exists!"
fi