#!/usr/bin/env bash

source message_functions || exit 1
source metadata_functions || exit 1
source locate_files || exit 1

run_dir=$1 && shift

if [[ -z "${run_dir}" ]]; then
    error "No run dir provided. Exiting"
fi

cuppa_chart_dir=$(locate_research_cuppa_chart)

venv_dir=${HOME}/venv
create_python_venv --venv_dir "${venv_dir}" --requirements "${cuppa_chart_dir}/requirements.txt" || exit 1
source "${venv_dir}/bin/activate" || exit 1

info "Venv environment of python3 is installed"

sampleId=$(load_tumor_sample_from_metadata ${run_dir})

info "Running cuppa chart of ${sampleId}"
python ${cuppa_chart_dir}/cuppa-chart.py \
    -sample ${sampleId} \
    -sample_data ${run_dir}/cuppa/${sampleId}.cup.data.csv \
    -output_dir ${run_dir}/cuppa/

info "Removing venv of python"
rm -r ${venv_dir}