#!/bin/bash

run_dir=$1 && shift
credentials=$1 && shift
purple_jar=$1 && shift
purple_output=$1 && shift

run=$(basename ${run_dir})

db_user=$(awk '/^user/ {print $2}' ${credentials})
db_pass=$(awk '/^pass/ {print $2}' ${credentials})
db_url=$(awk '/^url/ {print $2}' ${credentials})

baf_file=$(ls ${run_dir}/amber/*.amber.baf)
if [ $? -ne 0 ]
then
    echo "Amber BAF unavailable. Exiting."
    exit 1
fi

somatic_vcf=$(ls ${run_dir}/somaticVariants/*/*post_processed.vcf)
if [ $? -ne 0 ]
then
    echo "Unable to locate somatic variants. Exiting."
    exit 1
fi

structural_vcf=$(ls ${run_dir}/structuralVariants/bpi/*/*_somaticSV_bpi.vcf)
if [ $? -ne 0 ]
then
    echo "Unable to locate bpi structural variants. Exiting."
    exit 1
fi


mkdir -p ${purple_output}
rm -f ${purple_output}/*

java -Dorg.jooq.no-logo=true -Xmx8G -Xms4G \
    -jar ${purple_jar} \
    -threads 3 \
    -somatic_vcf ${somatic_vcf} \
    -structural_vcf ${structural_vcf} \
    -baf ${baf_file} \
    -circos /data/common/tools/circos_v0.69.5/bin/circos \
    -gc_profile ${gc_profile} \
    -run_dir ${run_dir} \
    -output_dir ${purple_output} \
    -db_enabled -db_user ${db_user} -db_pass ${db_pass} -db_url ${db_url} \
    $@