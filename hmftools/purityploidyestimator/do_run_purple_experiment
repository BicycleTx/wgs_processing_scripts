#!/bin/bash

run_dir=$1 && shift
run=$(basename ${run_dir})

credentials=/data/common/tools/patient-db_v1.0/credentials
db_user=$(awk '/^user/ {print $2}' ${credentials})
db_pass=$(awk '/^pass/ {print $2}' ${credentials})
db_url=mysql://localhost:3306/hmfpatients?serverTimezone=CET
purple_jar=/data/common/tools/purple_v1.0/purity-ploidy-estimator-1.0.jar

purple_output=${run_dir}/purple
full_vcf_file=${run_dir}/${run}.annotated.vcf
sliced_vcf_file=${run_dir}/${run}.annotated_sliced.vcf
fasta_file=/data/common/refgenomes/Homo_sapiens.GRCh37.decoys/hs37d5.fasta
bed_file=/data/common/dbs/CytoScanHD/CytoScanHD_hg19_SNPs_sorted.bed

if [[ ! -e ${full_vcf_file} ]]; then
    echo "Unable to locate VCF file" ${full_vcf_file}
    exit 1
fi

mkdir -p ${purple_output}

if [[ ! -e ${sliced_vcf_file} ]]; then
    echo "Creating sliced file" ${sliced_vcf_file}
    java -jar /data/common/tools/gatk_v3.4.46/GenomeAnalysisTK.jar -T SelectVariants -V ${full_vcf_file} -selectType SNP -o ${sliced_vcf_file} -R ${fasta_file} -L ${bed_file}
else
	echo "Using existing sliced file" ${sliced_vcf_file}    
fi

rm ${purple_output}/*purple*
exec java -Dorg.jooq.no-logo=true -Xmx8G -Xms4G -jar ${purple_jar} -run_dir $run_dir  -vcf_extension annotated_sliced.vcf -db_enabled -db_user ${db_user} -db_pass ${db_pass} -db_url ${db_url} $@
