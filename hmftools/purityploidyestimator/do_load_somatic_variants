#!/bin/bash
db_pass=$1
run_dir=$2

sample=$(ls ${run_dir} | grep -E '^(CPCT|DRUP)[0-9]{8}[^R]')
echo "Loading variant data for sample:" $sample

consensus_dir="/data/experiments/consensus_filtered"
consensus_file=${consensus_dir}"/"${sample}"_consensus_filtered.vcf"
if [[ ! -e ${consensus_file} ]]; then
    echo "Creating consensus_file:" ${consensus_file}
    apply_consensus_rule_to_run ${run_dir} ${consensus_file}
else
    echo "Consensus file" ${consensus_file} "already exists"
fi

PON=/data/common/dbs/PON_v1.0/PON.vcf
pon_annotated_dir="/data/experiments/consensus_filtered_pon/pon_annotated"
pon_annotated_file=${pon_annotated_dir}"/"${sample}"_consensus_filtered.vcf"
if [[ ! -e ${pon_annotated_file} ]]; then
    echo "Creating pon annotated file:" ${pon_annotated_file}	
	pypy /data/common/repos/scripts/analysisscripts/annotatePON.py -i $consensus_file -o $pon_annotated_file -p $PON

else
	echo "Pon annotated file" ${pon_annotated_file} "already exists"
fi

pon_filtered_dir="/data/experiments/consensus_filtered_pon/pon_filtered"
pon_filtered_file=${pon_filtered_dir}"/"${sample}"_consensus_filtered_pon.vcf"
if [[ ! -e ${pon_filtered_file} ]]; then
    echo "Creating pon filtered file:" ${pon_filtered_file}	
	bcftools filter -e 'PON_COUNT!="." && MIN(PON_COUNT) > 5' -s PON -m+ $pon_annotated_file > $pon_filtered_file
else
	echo "Pon filtered file" ${pon_filtered_file} "already exists"
fi


db_user=hmf
db_url=mysql://localhost:3306/hmfpatients?serverTimezone=CET
java -cp /data/common/tools/purple-v1.0/purity-ploidy-estimator-1.0.jar com.hartwig.hmftools.purple.LoadSomaticVariants -vcf_file ${pon_filtered_file} -db_user ${db_user} -db_pass ${db_pass} -db_url ${db_url} 