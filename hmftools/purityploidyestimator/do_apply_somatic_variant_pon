#!/bin/bash
run_dir=$1


# Files
vcf_in=$(ls ${run_dir}/somaticVariants/*/*melted.vcf)
if [ $? -ne 0 ]
then
	echo "Unable to locate VCF. Exiting"
	exit 1
fi

vcf_base=${vcf_in%.vcf}

PON=/data/common/dbs/PON_v1.0/PON.vcf
pon_file=${vcf_base}_consensus_filtered_pon.vcf
if [[ ! -e ${pon_file} ]]; then

    consensus_file=${vcf_base}_consensus_filtered.vcf
    tmp_file=${vcf_base}_tmp.vcf

    echo "Applying consensus rule"
    apply_consensus_rule_to_file ${vcf_in} ${consensus_file}

    echo "Creating pon file: ${pon_file}"
    pypy /data/common/repos/scripts/analysisscripts/annotatePON.py -i $consensus_file -p $PON -o $tmp_file
    bcftools filter -e 'PON_COUNT!="." && MIN(PON_COUNT) > 5' -s PON -m+ $tmp_file > $pon_file

    rm $tmp_file
    rm $consensus_file
else
	echo "Pon file ${pon_file} already exists"
fi
