#!/usr/bin/env bash

source locate_files || exit 1
source metadata_functions || exit 1

run_dir=$1 && shift
patient_db_jar=$1 && shift
credentials=$1 && shift

ref_sample=$(load_ref_sample_from_metadata ${run_dir})
tumor_sample=$(load_tumor_sample_from_metadata ${run_dir})

amber_dir=$(locate_amber_directory ${run_dir})
somatic_vcf=$(locate_purple_somatic_variants ${run_dir})
germline_vcf=$(locate_purple_germline_variants ${run_dir})
structural_vcf=$(locate_purple_structural_variants ${run_dir})
chord_prediction_file=$(locate_chord_prediction ${run_dir})
protect_evidence_tsv=$(locate_protect_evidence ${run_dir})

ref_metrics_file=$(locate_wgs_metrics ${run_dir} ${ref_sample})
tumor_metrics_file=$(locate_wgs_metrics ${run_dir} ${tumor_sample})
ref_flagstat_file=$(locate_flagstats ${run_dir} ${ref_sample})
tumor_flagstat_file=$(locate_flagstats ${run_dir} ${tumor_sample})

# TODO Switch to prod data and load it
peach_pilot_calls_tsv=$(locate_peach_pilot_calls ${run_dir})
peach_pilot_genotype_tsv=$(locate_peach_pilot_genotype ${run_dir})

credentials=$(locate_pilot_database_credentials)
patient_db_jar=$(locate_pilot_patient_db)

# TODO Load CUPPA
# TODO Load VirusBreakend

do_load_amber_data ${tumor_sample} ${amber_dir} ${credentials} ${patient_db_jar}
do_load_purple_data ${tumor_sample} ${run_dir}/purple ${credentials} ${patient_db_jar}
do_load_somatic_variants ${tumor_sample} ${ref_sample} ${somatic_vcf} ${credentials} ${patient_db_jar}
do_load_germline_variants ${tumor_sample} ${ref_sample} ${germline_vcf} ${credentials} ${patient_db_jar}
do_load_structural_variants ${tumor_sample} ${structural_vcf} ${credentials} ${patient_db_jar}
do_load_linx_data ${tumor_sample} ${run_dir}/linx ${credentials} ${patient_db_jar}
do_load_metrics_data ${tumor_sample} ${ref_metrics_file} ${tumor_metrics_file} ${credentials} ${patient_db_jar}
do_load_flagstat_data ${tumor_sample} ${ref_flagstat_file} ${tumor_flagstat_file} ${credentials} ${patient_db_jar}
do_load_chord_data ${tumor_sample} ${chord_prediction_file} ${credentials} ${patient_db_jar}
do_load_protect_data ${tumor_sample} ${protect_evidence_tsv} ${credentials} ${patient_db_jar}
# do_load_peach_data ${sample} ${peach_pilot_calls_tsv} ${peach_pilot_genotype_tsv} ${credentials} ${patient_db_jar}
do_load_snv_signatures ${tumor_sample} ${credentials}
