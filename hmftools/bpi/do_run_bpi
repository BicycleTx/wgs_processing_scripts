#!/bin/bash
source load_metadata

run_dir=$1 && shift
bpi_jar=$1 && shift
bpi_output=$1 && shift
bpi_version=$1 && shift
metadata=${run_dir}/metadata

if [[ ! -f ${metadata} ]] ; then
    echo "Missing metadata file in run directory. Aborting" 1>&2
    exit 1
fi

ref_sample=$(load_ref_sample_from_metadata ${run_dir})
tumor_sample=$(load_tumor_sample_from_metadata ${run_dir})
joint_name=$(load_joint_name_from_metadata ${run_dir})

base_path="/data/common"
if [ -z "`hostname | grep datastore`" ]; then
    # KODU: common folder does not exist on crunches...
	base_path="/data"
fi

samtools=${base_path}/tools/samtools_v1.2/samtools

mkdir -p ${bpi_output}

structural_vcf=$(ls ${run_dir}/structuralVariants/manta/*/results/variants/somaticSV.vcf.gz)
if [ $? -ne 0 ]
then
	echo "Unable to locate Manta structural variants. Exiting."
	exit 1
fi

tumor_sliced_bam=${run_dir}/structuralVariants/bpi/${joint_name}/${tumor_sample}_sliced.bam
if [ ! -f ${tumor_sliced_bam} ]
then
    echo "Unable to locate sliced tumor bam (${tumor_sliced_bam}). Exiting."
    exit 1
fi
${samtools} index ${tumor_sliced_bam}

ref_sliced_bam=${run_dir}/structuralVariants/bpi/${joint_name}/${ref_sample}_sliced.bam
if [ ! -f ${ref_sliced_bam} ]
then
    echo "Unable to locate sliced ref bam (${ref_sliced_bam}). Exiting."
    exit 1
fi
${samtools} index ${ref_sliced_bam}

output_tsv=$(ls ${bpi_output}/*/*.tsv)
if [ $? -ne 0 ]
then
    echo "Unable to locate original bpi tsv. Exiting."
    exit 1
fi

output_vcf=$(dirname ${output_tsv})/${joint_name}_somaticSV_bpi.vcf.gz

if grep -q bpiVersion=${bpi_version} ${output_vcf}; then
    echo "BPI version ${bpi_version} already run. Exiting."
    exit 1
fi

echo "Running BPI on ${run_dir}"

java -Xmx8G -Xms4G -Djava.io.tmpdir=/data/tmp -jar ${bpi_jar} \
    -ref_bam ${ref_sliced_bam} \
    -tumor_bam ${tumor_sliced_bam} \
    -input_vcf ${structural_vcf} \
    -output_vcf ${output_vcf} \
    -output_tsv ${output_tsv} \
    -contamination_fraction 0.03
