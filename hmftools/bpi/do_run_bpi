#!/bin/bash

run_dir=$1 && shift
bpi_jar=$1 && shift
bpi_output=$1 && shift
samtools=/data/common/tools/samtools_v1.2/samtools

mkdir -p ${bpi_output}

structural_vcf=$(ls ${run_dir}/structuralVariants/manta/*/results/variants/somaticSV.vcf.gz)
if [ $? -ne 0 ]
then
	echo "Unable to locate Manta structural variants. Exiting."
	exit 1
fi

tumor_bam=$(find ${run_dir}/structuralVariants/bpi/*/ -regex ".*T\(I\)*_sliced\.bam")
if [ $? -ne 0 ]
then
    echo "Unable to locate tumor bam. Exiting."
    exit 1
fi
${samtools} index ${tumor_bam}

ref_bam=$(ls ${run_dir}/structuralVariants/bpi/*/*R_sliced.bam)
if [ $? -ne 0 ]
then
    echo "Unable to locate ref bam. Exiting."
    exit 1
fi
${samtools} index ${ref_bam}

output_tsv=$(ls ${bpi_output}/*/*.tsv)
if [ $? -ne 0 ]
then
    echo "Unable to locate original bpi tsv. Exiting."
    exit 1
fi

joint_name=$(realpath ${output_tsv} | awk -F/ '{print $8}')
echo realpath ${output_tsv}
echo ${output_tsv}
exit

output_vcf=$(dirname ${output_tsv})/${joint_name}_somaticSV_bpi.vcf

if grep -q bpiVersion=1.5 ${output_vcf}; then
    echo "BPI version 1.5 already run. Exiting."
    exit 1
fi

java -Xmx8G -Xms4G \
    -jar ${bpi_jar} \
    -contamination_fraction 0.03 \
    -vcf ${structural_vcf} \
    -ref ${ref_bam} \
    -tumor ${tumor_bam} \
    -output_vcf ${output_vcf} \
    > ${output_tsv}
