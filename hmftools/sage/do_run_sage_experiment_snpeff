#!/usr/bin/env bash

source metadata_functions

prefix=$(dirname $(readlink $0 || echo $0))
run_dir=$1 && shift
set=$(basename ${run_dir})

hotspot_bed=/data/common/dbs/sage/ActionableExonPanel.hg19.bed

sample=$(load_tumor_sample_from_metadata ${run_dir})
normal=$(load_ref_sample_from_metadata ${run_dir})
joint_name=$(load_joint_name_from_metadata ${run_dir})

out_dir=/data/experiments/191119_sage_panel_slices/${sample}/
mkdir -p ${out_dir}

sample_bam=/data/experiments/191119_sage_panel_slices/bams/${sample}.panel.bam
normal_bam=/data/experiments/191119_sage_panel_slices/bams/${normal}.panel.bam

sage_vcf=${out_dir}/${sample}.sage.vcf.gz
pon1_vcf=${out_dir}/${sample}.pon1.vcf.gz
pon2_vcf=${out_dir}/${sample}.pon2.vcf.gz
final_vcf=${out_dir}/${sample}.final.vcf.gz
snpeff_vcf=${out_dir}/${sample}.snpeff.vcf


if [ ! -f ${snpeff_vcf} ]; then
    echo "[ERROR] No final file to snpeff"
    exit 1
fi

java -jar /data/common/tools/snpEff_v4.3s/snpEff.jar \
    -c "/data/common/tools/snpEff_v4.3s/snpEff.config" "GRCh37.75" \
    -v ${final_vcf} \
    -hgvs -lof -no-downstream -ud 1000 -no-intergenic -noShiftHgvs \
    > ${snpeff_vcf}

bgzip ${snpeff_vcf}
tabix -p vcf ${snpeff_vcf}.gz