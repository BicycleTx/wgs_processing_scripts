#!/usr/bin/env bash

iclusion_importer_jar=$1 && shift
iclusion_trial_tsv=$1 && shift

iclusion_api_credentials=$( gcloud secrets versions access "latest" --secret=iclusion-api-credentials --project=hmf-secrets )

iclusion_endpoint=$(echo ${iclusion_api_credentials} | sed 's/: /:/g' | sed 's/ /\n/g' | grep endpoint: | cut -d":" -f2 | sed 's/"//g')
iclusion_client_id=$(echo ${iclusion_api_credentials} | sed 's/: /:/g' | sed 's/ /\n/g' | grep client_id: | cut -d":" -f2 | sed 's/"//g')
iclusion_client_secret=$(echo ${iclusion_api_credentials} | sed 's/: /:/g' | sed 's/ /\n/g' | grep client_secret: | cut -d":" -f2 | sed 's/"//g')
iclusion_user=$(echo ${iclusion_api_credentials} | sed 's/: /:/g' | sed 's/ /\n/g' | grep username: | cut -d":" -f2 | sed 's/"//g')
iclusion_password=$(echo ${iclusion_api_credentials} | sed 's/: /:/g' | sed 's/ /\n/g' | grep password: | cut -d":" -f2 | sed 's/"//g')

java -jar ${iclusion_importer_jar} \
    -iclusion_endpoint ${iclusion_endpoint} \
    -iclusion_client_id ${iclusion_client_id} \
    -iclusion_client_secret ${iclusion_client_secret} \
    -iclusion_username ${iclusion_user} \
    -iclusion_password ${iclusion_password} \
    -iclusion_trial_tsv ${iclusion_trial_tsv} \
    "$@"
