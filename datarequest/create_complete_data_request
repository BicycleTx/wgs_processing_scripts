#!/usr/bin/env bash

dr_name=$1 && shift
request_name=$1 && shift
patient_selection_sql=$1 && shift

if [ -z "${dr_name}" ] || [ -z "${request_name}" ] || [ -z "${patient_selection_sql}" ]; then
    echo "Usage: create_complete_data_request dr_name request_name path_to_patient_selection_sql"
    echo "   eg create_complete_data_request DR-028 DR-028-update2 /data/data_archive/datarequests/procedure/patient_selection_sql/DR-028.sql"
    echo "   You should use template_selectPatients.sql as basis for the patient selection sql"
    exit 1
fi

base_path=/data/data_archive/datarequests
datareq_input_tsv=${base_path}/procedure/latest/metadata

dr_path=${base_path}/${dr_name}/${request_name}
create_base_directory_for_datarequest ${dr_path}
if [ $? = 0 ]; then
    log_dir=${dr_path}/logs
    mkdir -p ${log_dir}

    echo "[INFO] Selecting patients to include for ${request_name}..."
    cp ${patient_selection_sql} ${log_dir}/selectPatients.sql
    patient_selection_tsv=${log_dir}/selectPatients.tsv
    exec_sql_on_prod ${log_dir}/selectPatients.sql > ${patient_selection_tsv}
    patient_count=$( grep -cv "^#" ${patient_selection_tsv})
    echo "[INFO] Created ${patient_selection_tsv} with ${patient_count} patients"

    echo "[INFO] Creating metadata for ${request_name}..."
    base_metadata_unfiltered_tsv=${log_dir}/metadata_unfiltered.tsv
    base_metadata_filtered_tsv=${log_dir}/metadata_filtered.tsv
    create_base_metadata_for_request ${patient_selection_tsv} ${datareq_input_tsv} ${base_metadata_unfiltered_tsv} ${base_metadata_filtered_tsv}
    base_metadata_final_tsv=${log_dir}/metadata_final.tsv

    # TODO: Pick the one relevant for this DR!
    filter_metadata_tumor ${base_metadata_filtered_tsv} ${base_metadata_final_tsv}
    #filter_metadata_tumor_patient ${base_metadata_filtered_tsv} ${base_metadata_final_tsv}
    #filter_metadata_tumor_patient_treatment ${base_metadata_filtered_tsv} ${base_metadata_final_tsv}

    metadata_dir=${dr_path}/metadata
    mkdir -p ${metadata_dir}
    metadata_tsv=${metadata_dir}/metadata.tsv
    cp ${base_metadata_final_tsv} ${metadata_tsv}
    sample_count=$( grep -cv "^#" ${metadata_tsv} )
    echo "[INFO] Created ${metadata_tsv} with ${sample_count} samples"

    # TODO Only collect RNA data when relevant for DR
    echo "[INFO] Collecting RNA seq for ${request_name}..."
    rnaseq_dir=${dr_path}/rnaseq
    mkdir -p ${rnaseq_dir}
    collect_all_rna_data_for_request ${metadata_tsv} ${rnaseq_dir}
    rna_sample_count=$( ls ${rnaseq_dir} | wc -l)
    echo "[INFO] Done collecting RNA seq for DR. Found ${rna_sample_count} samples"

    # TODO Only collect somatic data when relevant for DR
    echo "[INFO] Collecting somatic data for ${request_name}..."
    somatics_dir=${dr_path}/somatics
    mkdir -p ${somatics_dir}
    collect_all_somatic_set_data_for_request ${metadata_tsv} ${somatics_dir}
    somatics_sample_count=$( ls ${somatics_dir} | wc -l)
    echo "[INFO] Done collecting somatics for DR. Found ${somatics_sample_count} samples"

    # TODO Only collect germline data when relevant for DR
    echo "[INFO] Collecting germline data for ${request_name}..."
    germline_dir=${dr_path}/germline
    mkdir -p ${germline_dir}
    collect_all_germline_set_data_for_request ${metadata_tsv} ${germline_dir}
    germline_sample_count=$( ls ${germline_dir} | wc -l)
    echo "[INFO] Done collecting germline data for DR. Found ${germline_sample_count} samples"

    # TODO Only create BAM jsons when relevant for DR
    echo "[INFO] Creating share jsons for ${request_name}..."
    base_json_dir=${dr_path}/logs/json
    mkdir -p ${base_json_dir}
    create_tumor_bam_share_jsons_for_datarequest ${metadata_tsv} ${dr_name} ${base_json_dir}
    create_reference_bam_share_jsons_for_datarequest ${metadata_tsv} ${dr_name} ${base_json_dir}
    echo "[INFO] Done creating share jsons for DR"

    # TODO Only create extra clinical data when relevant for DR
    echo "[INFO] Creating extra clinical data for ${request_name}..."
    generate_post_biopsy_drugs_by_biopsy ${metadata_tsv} ${log_dir} ${metadata_dir}
    generate_pre_biopsy_drugs_by_patient ${metadata_tsv} ${log_dir} ${metadata_dir}
    generate_responses_by_biopsy ${metadata_tsv} ${log_dir} ${metadata_dir}
    echo "[INFO] Done creating extra clinical data for DR"
else
    echo "[ERROR] Could not create base directory structure for DR ${dr_name}"
fi


