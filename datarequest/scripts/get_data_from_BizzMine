#!/usr/bin/env bash

print_usage(){
    echo "-----"
    echo " Descr: Get data from BizzMine"
    echo " Usage: $(basename $0) -i <dr-id>"
    echo " Exmpl: $(basename $0) -i 'DR-001'"
    echo "-----"
    exit 1
}

while getopts ':i:' flag; do
    case "${flag}" in
        i) dr_id=${OPTARG} ;;
        *) print_usage
        exit 1 ;;
    esac
done

if [[ -z "${dr_id}" ]]; then
    echo "[ERROR] script get_data_from_BizzMine did not run, check usage below:"
    print_usage
fi


api_url=$"https://api.bizzmine.cloud/collection/DataRequests/"
api_token=$( cat /data/common/dbs/api_credentials/bizzmine/api_token )

## quick input checks
[[ ! -z "${dr_id}" && "${dr_id}" =~ ^DR ]] || die "dr-id incorrect (${dr_id})?"

release_id=$"${dr_id}"

## start with script
echo ""
echo "[START] get_data_from_BizzMine: $(date +"%y%m%d (%T)")"
echo ""

echo "--- DETAILS DATA ACCESS REQUEST: $release_id ---"
echo ""

datarequest_id=$( curl get -s -H "x-token: ${api_token}" -H "x-tenant: hartwigmedicalfoundation" https://api.bizzmine.cloud/collection/DataRequests/instances | jq --arg DR_select "$release_id" '.[] | select(.DataRequests_DR_1_0_Datarequest_referencenumber==$DR_select) | .DataRequests_DataRequestsID | .[]' )
curl get -s -H "x-token: ${api_token}" -H "x-tenant: hartwigmedicalfoundation" https://api.bizzmine.cloud/collection/DataRequests/instance/${datarequest_id} > temp.json

jq -r '.[] | "Main applicant - " + .DataRequests_DR_1_2_Mainapplicant[].value + " (" + .DataRequests_1_2_Emailaddress_mainapplicant + ")"' <temp.json
jq -r '.[] | "Main applicant 2 - " + .DataRequests_DR_1_2_Mainapplicant2 + " (" + .DataRequests_1_2_Emailaddress_mainapplicant2 + ")"' <temp.json
echo ""
jq -r '.[] | "GCP account download contact - " + .Researchers[].Researchers_13Emailresearcherinvolvedintheproject' <temp.json
jq -r '.[] | "Extra added GCP account of download contact - " + .Extraresearchers[].Extra_researchers_Emailextraresearcherinvolvedintheproject' <temp.json
echo ""
jq -r '.[] | "Requested patient selection - " + .DataRequests_DR_3_1_Requested_patientselection.text + " " + .DataRequests_DR_3_1_Requested_patientselection_specified' <temp.json
echo ""
jq -r '.[] | "Metadata - tumor: " + .DataRequests_DR_3_2_tumourdata' <temp.json
jq -r '.[] | "Metadata - patient: " + .DataRequests_DR_3_2_patientdata' <temp.json
jq -r '.[] | "Metadata - pre treatment: " + .DataRequests_DR_3_2_previoustreatmentdata' <temp.json
jq -r '.[] | "Metadata - post treatment + response: " + .DataRequests_DR_3_2_postbiopsytreatmentdata' <temp.json
echo ""
jq -r '.[] | "DNA - Somatic data: " + .DataRequests_DR_3_3_SomaticanalysesdataDNa' <temp.json
jq -r '.[] | "DNA - Germline data: " + .DataRequests_DR_3_3_germlineanalysesdataDNa' <temp.json
jq -r '.[] | "DNA - Raw data (CRAM): " + .DataRequests_DR_3_3_rawdataDNa' <temp.json
jq -r '.[] | "RNA - Raw data (FASTQ): " + .DataRequests_DR_3_3_rawdataRNa' <temp.json
echo ""
jq -r '.[] | "Other data: " + .DataRequests_DR_3_3_other' <temp.json