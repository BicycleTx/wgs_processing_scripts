#!/usr/bin/env bash

patient_selection_tsv=$1 && shift
datareq_input_tsv=$1 && shift
base_metadata_unfiltered_tsv=$1 && shift
base_metadata_filtered_tsv=$1 && shift

## select metadata info of all biopsies for each patient
head -1 ${datareq_input_tsv} | sed 's/sbpSetName/setName/' > ${base_metadata_unfiltered_tsv}
cat ${patient_selection_tsv} | grep -v "^#" | while read patient_id; do
    grep ${patient_id} ${datareq_input_tsv}
done | sort | uniq >> ${base_metadata_unfiltered_tsv}

## =======================
## FILTER
## =======================

## HEADER
cat ${base_metadata_unfiltered_tsv} | grep "^#" > ${base_metadata_filtered_tsv}
## SETS
cat ${base_metadata_unfiltered_tsv} | grep -v "^#" | awk '$8 ~ /^PASS$/' | awk '$9 !~ /NO_TUMOR/' | awk '$10 > 0.195' >> ${base_metadata_filtered_tsv}

## report on debug filtering results.
count_before=$( cat ${base_metadata_unfiltered_tsv} | grep -v "^#" | wc -l )
count_after=$( cat ${base_metadata_filtered_tsv} | grep -v "^#" | wc -l )
echo "[DEBUG] Metadata output filtered from ${count_before} to ${count_after}"

