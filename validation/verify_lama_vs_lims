#!/usr/bin/env bash

source message_functions || exit 1

LIMS_JSON="/data/ops/lims/prod/lims.json"
LAMA_JSON="/data/ops/lims/pilot/lims.json"

search_strings=("$@")
compare_mode="true"

check_fields=(
  patient
  sample_name
  sample_id
  submission
  entity
  project_name
  cohort
  shallowseq
  analysis_type
  lab_status
  ref_sample_id
  report_viral
  report_pgx
  report_germline
  report_germline_level
  sampling_date
  arrival_date
  report_date
  biopsy_site
  hospital_pa_sample_id
  hospital_patient_id
  lab_sop_versions
  yield
)

rna_barcodes=(FR10244761)
dna_barcodes=(FR17437143)

main () {
  if [[ "${#search_strings[@]}" -gt 0 ]]; then
    for search_string in "${search_strings[@]}"; do
      check_sample "$search_string"
    done
  else
    info "## RNA samples ##"
    for search_string in "${rna_barcodes[@]}"; do
      check_sample "$search_string"
    done
    echo ""
    info "## DNA samples ##"
    for search_string in "${dna_barcodes[@]}"; do
      check_sample "$search_string"
    done
  fi
}

check_sample () {
  local barcode=$1 && shift
  echo "-- Checking sample $search_string --"
    if [[ "$compare_mode" == "true" ]]; then
      compare_by_sample_barcode "$barcode"
    else
      print_tsv_by_sample_barcode "$barcode"
    fi
}

compare_by_sample_barcode () {
  local barcode=$1 && shift
  lims_result=$(query_lims "$LIMS_JSON" "$barcode" "json")
  lama_result=$(query_lims "$LAMA_JSON" "$barcode" "json")

  for field_name in "${check_fields[@]}"; do
    lims_val=$(jq -r --arg key "$field_name" '.[$key]' <<< "$lims_result")
    lama_val=$(jq -r --arg key "$field_name" '.[$key]' <<< "$lama_result")
    result="FAIL"
    if [[ "$lims_val" == "" && "$lama_val" == "null" ]]; then
      result="OK"
    elif [[ "$lims_val" == "$lama_val" ]]; then
      result="OK"
    fi
    echo "$result: $barcode $field_name ($lims_val vs $lama_val)"
  done
  echo "# See also:"
  echo " query_lims.pl -rna -lims $LIMS_JSON -type samples -filter sample_id=$barcode -json"
  echo " query_lims.pl -rna -lims $LAMA_JSON -type samples -filter sample_id=$barcode -json"
}

print_tsv_by_sample_barcode () {
  local barcode=$1 && shift
  lims_result=$(query_lims "$LIMS_JSON" "$barcode" "tsv")
  lama_result=$(query_lims "$LAMA_JSON" "$barcode" "tsv")
  printf "%s: %s\n" "LIMS" "$lims_result"
  printf "%s: %s\n" "LAMA" "$lama_result"
}

query_lims () {
  local json=$1 && shift
  local barcode=$1 && shift
  local output=$1 && shift
  if [[ "$output" == 'json' ]]; then
    result=$(query_lims.pl -rna -lims "$json" -type samples -filter "sample_id=$barcode" -json | jq -r '.[-1]')
  elif [[ "$output" == 'tsv' ]]; then
    result=$(query_lims.pl -rna -lims "$json" -type samples -filter "sample_id=$barcode")
  else
    die "Unknown output type given to query_lims ($output)"
  fi
  echo "$result"
}

main