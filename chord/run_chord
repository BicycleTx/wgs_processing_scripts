#!/bin/bash

source load_metadata
prefix=`dirname $(readlink $0 || echo $0)`
run_dir=$1 && shift
sample=$(load_tumor_sample_from_metadata ${run_dir})
path="/data/experiments/hrd_classifier_evaluation/output/${sample}/"

mkdir ${path}

somatic_vcf=$(ls ${run_dir}/somaticVariants/*/*post_processed_v2.2.vcf.gz)
if [ $? -ne 0 ]
then
    # TODO (KODU): Clean up after pipeline v3 does not exist anymore.
    somatic_vcf=$(ls ${run_dir}/somaticVariants/*/*post_processed.vcf.gz)
    if [ $? -ne 0 ]
    then
        echo "Unable to locate post processed somatic variants. Exiting."
        exit 1
    fi
fi

structural_vcf=$(ls ${run_dir}/structuralVariants/bpi/*/*_somaticSV_bpi.vcf)
if [ $? -ne 0 ]
then
    # TODO (KODU): Clean up after pipeline v3 does not exist anymore.
    structural_vcf=$(ls ${run_dir}/structuralVariants/bpi/*/*_somaticSV_bpi.vcf.gz)
    if [ $? -ne 0 ]
    then
        echo "Unable to locate bpi structural variants. Exiting."
        exit 1
    fi
fi

extractHRDsample.R ${somatic_vcf} ${structural_vcf} ${sample} ${path}

sample_mut_signatures=sample_mut_signatures.txt
predictHRDsample.R ${sample_mut_signatures} ${path}